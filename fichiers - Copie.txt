// scripts/themes.js

const themesManager = {
    pickrInstances: {},
    currentTheme: 'light',
    hasChanges: false,
    loadedThemes: null, // Stocker les th√®mes charg√©s
    
    // Valeurs par d√©faut
    defaultValues: {
        light: {
            primaryColor: '#6a11cb',
            backgroundColor: '#ffffff',
            gradientStart: '#6a11cb',
            gradientEnd: '#2575fc'
        },
        dark: {
            primaryColor: '#8b5cf6',
            backgroundColor: '#1a1a1a',
            gradientStart: '#8b5cf6',
            gradientEnd: '#3b82f6'
        }
    },
    
    // Valeurs actuelles
    currentValues: {
        light: {},
        dark: {}
    },
    
    async init() {
        // 1. D'abord charger les th√®mes depuis Firebase
        await this.loadSavedThemes();
        
        // 2. Initialiser les tabs
        this.initTabs();
        
        // 3. Initialiser les color pickers AVEC les bonnes valeurs
        this.initColorPickers();
        
        // 4. Initialiser les event listeners
        this.initEventListeners();
        
        // 5. Mettre √† jour la preview
        this.updatePreview();
    },
    
    async loadSavedThemes() {
        try {
            const doc = await db.collection('config').doc('themes').get();
            
            console.log('=== CHARGEMENT DES TH√àMES ===');
            console.log('Document exists:', doc.exists);
            
            if (doc.exists) {
                const themes = doc.data();
                console.log('Th√®mes charg√©s depuis Firebase:', JSON.stringify(themes, null, 2));
                
                // Stocker les th√®mes charg√©s
                this.loadedThemes = themes;
                
                // Copier profond√©ment les th√®mes
                this.currentValues = {
                    light: themes.light ? {...themes.light} : {...this.defaultValues.light},
                    dark: themes.dark ? {...themes.dark} : {...this.defaultValues.dark}
                };
            } else {
                console.log('Aucun th√®me trouv√©, utilisation des valeurs par d√©faut');
                this.loadedThemes = {...this.defaultValues};
                this.currentValues = {
                    light: {...this.defaultValues.light},
                    dark: {...this.defaultValues.dark}
                };
            }
            
            console.log('CurrentValues apr√®s chargement:', JSON.stringify(this.currentValues, null, 2));
            
        } catch (error) {
            console.error('Erreur lors du chargement des th√®mes:', error);
            this.loadedThemes = {...this.defaultValues};
            this.currentValues = {
                light: {...this.defaultValues.light},
                dark: {...this.defaultValues.dark}
            };
        }
    },
    
    initTabs() {
        const tabs = document.querySelectorAll('.theme-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.theme-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}Theme`).classList.add('active');
                
                this.currentTheme = tabId;
                this.updatePreview();
            });
        });
    },
    
    initColorPickers() {
        const colorInputs = document.querySelectorAll('.color-input');
        
        colorInputs.forEach(input => {
            const previewId = input.id.replace('Input', 'Preview');
            const preview = document.getElementById(previewId);
            
            // D√©terminer le mode et le type de couleur
            const mode = input.id.includes('light') ? 'light' : 'dark';
            let colorType = '';
            
            if (input.id.includes('Primary')) {
                colorType = 'primaryColor';
            } else if (input.id.includes('Bg') && !input.id.includes('Gradient')) {
                colorType = 'backgroundColor';
            } else if (input.id.includes('GradientStart')) {
                colorType = 'gradientStart';
            } else if (input.id.includes('GradientEnd')) {
                colorType = 'gradientEnd';
            }
            
            // R√©cup√©rer la couleur sauvegard√©e ou par d√©faut
            const savedColor = this.currentValues[mode][colorType] || this.defaultValues[mode][colorType];
            
            console.log(`Init Pickr pour ${input.id}: ${savedColor}`);
            
            // Appliquer la couleur √† l'input et au preview
            input.value = savedColor;
            preview.style.background = savedColor;
            
            // Cr√©er le Pickr avec la bonne couleur
            const pickr = Pickr.create({
                el: preview,
                theme: 'classic',
                default: savedColor,
                swatches: [
                    '#6a11cb', '#2575fc', '#8b5cf6', '#3b82f6',
                    '#10b981', '#ef4444', '#f59e0b', '#8b5cf6',
                    '#ffffff', '#1a1a1a', '#f3f4f6', '#111827'
                ],
                components: {
                    preview: true,
                    opacity: false,
                    hue: true,
                    interaction: {
                        hex: true,
                        rgba: false,
                        hsva: false,
                        input: true,
                        clear: false,
                        save: true
                    }
                }
            });
            
            pickr.on('save', (color) => {
                if (!color) return;
                const hexColor = color.toHEXA().toString();
                input.value = hexColor;
                preview.style.background = hexColor;
                this.updateCurrentValues(input.id, hexColor);
                this.onColorChange();
                pickr.hide();
            });
            
            pickr.on('change', (color) => {
                if (!color) return;
                const hexColor = color.toHEXA().toString();
                preview.style.background = hexColor;
            });
            
            // Stocker l'instance pickr
            this.pickrInstances[input.id] = pickr;
            
            // √âcouter les changements manuels dans l'input
            input.addEventListener('input', (e) => {
                const color = e.target.value;
                if (this.isValidColor(color)) {
                    preview.style.background = color;
                    if (pickr) {
                        pickr.setColor(color);
                    }
                    this.updateCurrentValues(e.target.id, color);
                    this.onColorChange();
                }
            });
            
            input.addEventListener('change', (e) => {
                const color = e.target.value;
                if (!this.isValidColor(color)) {
                    const fallbackColor = savedColor;
                    e.target.value = fallbackColor;
                    preview.style.background = fallbackColor;
                    if (pickr) {
                        pickr.setColor(fallbackColor);
                    }
                } else {
                    this.updateCurrentValues(e.target.id, color);
                    this.onColorChange();
                }
            });
        });
    },
    
    updateCurrentValues(inputId, color) {
        const mode = inputId.includes('light') ? 'light' : 'dark';
        
        if (inputId.includes('Primary')) {
            this.currentValues[mode].primaryColor = color;
        } else if (inputId.includes('Bg') && !inputId.includes('Gradient')) {
            this.currentValues[mode].backgroundColor = color;
        } else if (inputId.includes('GradientStart')) {
            this.currentValues[mode].gradientStart = color;
        } else if (inputId.includes('GradientEnd')) {
            this.currentValues[mode].gradientEnd = color;
        }
        
        console.log(`Valeur mise √† jour: ${inputId} = ${color}`);
        console.log('CurrentValues maintenant:', JSON.stringify(this.currentValues, null, 2));
    },
    
    initEventListeners() {
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment r√©initialiser tous les th√®mes aux valeurs par d√©faut ?')) {
                this.resetToDefaults();
            }
        });
        
        document.getElementById('saveBtn').addEventListener('click', () => {
            this.saveThemes();
        });
    },
    
    onColorChange() {
        this.hasChanges = true;
        document.getElementById('saveBtn').disabled = false;
        this.updatePreview();
    },
    
    updatePreview() {
        const theme = this.currentValues[this.currentTheme];
        
        if (!theme) return;
        
        const primaryColor = theme.primaryColor;
        const backgroundColor = theme.backgroundColor;
        const gradientStart = theme.gradientStart;
        const gradientEnd = theme.gradientEnd;
        
        const root = document.documentElement;
        root.style.setProperty('--primary-color', primaryColor);
        root.style.setProperty('--background-color', backgroundColor);
        root.style.setProperty('--accent-gradient', `linear-gradient(135deg, ${gradientStart} 0%, ${gradientEnd} 100%)`);
        
        const hoverBg = this.lightenDarkenColor(backgroundColor, this.currentTheme === 'light' ? -5 : 10);
        const borderColor = this.lightenDarkenColor(backgroundColor, this.currentTheme === 'light' ? -15 : 20);
        
        root.style.setProperty('--hover-bg', hoverBg);
        root.style.setProperty('--border-color', borderColor);
        
        if (this.currentTheme === 'dark') {
            root.style.setProperty('--menu-bg', this.lightenDarkenColor(backgroundColor, 20));
            root.style.setProperty('--text-primary', '#f5f5f5');
            root.style.setProperty('--text-secondary', '#a0a0a0');
        } else {
            root.style.setProperty('--menu-bg', '#ffffff');
            root.style.setProperty('--text-primary', '#1a1a1a');
            root.style.setProperty('--text-secondary', '#666666');
        }
    },
    
    lightenDarkenColor(color, percent) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        
        return "#" + (
            0x1000000 +
            (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
            (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
            (B < 255 ? (B < 1 ? 0 : B) : 255)
        ).toString(16).slice(1);
    },
    
    isValidColor(color) {
        const s = new Option().style;
        s.color = color;
        return s.color !== '';
    },
    
    resetToDefaults() {
        this.currentValues = {
            light: {...this.defaultValues.light},
            dark: {...this.defaultValues.dark}
        };
        
        // Mettre √† jour tous les inputs et pickr
        ['light', 'dark'].forEach(mode => {
            Object.keys(this.defaultValues[mode]).forEach(colorType => {
                let inputId = '';
                if (colorType === 'primaryColor') inputId = `${mode}PrimaryInput`;
                else if (colorType === 'backgroundColor') inputId = `${mode}BgInput`;
                else if (colorType === 'gradientStart') inputId = `${mode}GradientStartInput`;
                else if (colorType === 'gradientEnd') inputId = `${mode}GradientEndInput`;
                
                const input = document.getElementById(inputId);
                const preview = document.getElementById(inputId.replace('Input', 'Preview'));
                const color = this.defaultValues[mode][colorType];
                
                if (input && preview) {
                    input.value = color;
                    preview.style.background = color;
                    if (this.pickrInstances[inputId]) {
                        this.pickrInstances[inputId].setColor(color);
                    }
                }
            });
        });
        
        this.hasChanges = true;
        document.getElementById('saveBtn').disabled = false;
        this.updatePreview();
    },
    
    async saveThemes() {
        try {
            console.log('=== D√âBUT SAUVEGARDE ===');
            console.log('CurrentValues COMPLET:', JSON.stringify(this.currentValues, null, 2));
            
            // Cr√©er l'objet √† sauvegarder avec TOUTES les valeurs actuelles
            const themes = {
                light: {
                    primaryColor: this.currentValues.light.primaryColor,
                    backgroundColor: this.currentValues.light.backgroundColor,
                    gradientStart: this.currentValues.light.gradientStart,
                    gradientEnd: this.currentValues.light.gradientEnd
                },
                dark: {
                    primaryColor: this.currentValues.dark.primaryColor,
                    backgroundColor: this.currentValues.dark.backgroundColor,
                    gradientStart: this.currentValues.dark.gradientStart,
                    gradientEnd: this.currentValues.dark.gradientEnd
                }
            };
            
            console.log('Objet √† sauvegarder:', JSON.stringify(themes, null, 2));
            
            // V√©rifier qu'aucune valeur n'est undefined
            let hasUndefined = false;
            ['light', 'dark'].forEach(mode => {
                Object.keys(themes[mode]).forEach(key => {
                    if (!themes[mode][key]) {
                        console.error(`ERREUR: ${mode}.${key} est undefined!`);
                        hasUndefined = true;
                    }
                });
            });
            
            if (hasUndefined) {
                alert('Erreur: Certaines couleurs ne sont pas d√©finies. Veuillez v√©rifier.');
                return;
            }
            
            // Mettre √† jour le cache localStorage
            localStorage.setItem('cachedThemes', JSON.stringify(themes));
            
            // Sauvegarder dans Firebase
            await db.collection('config').doc('themes').set(themes);
            
            console.log('‚úÖ Sauvegarde Firebase r√©ussie');
            
            // V√©rifier la sauvegarde
            const verifyDoc = await db.collection('config').doc('themes').get();
            console.log('‚úÖ V√©rification apr√®s sauvegarde:', JSON.stringify(verifyDoc.data(), null, 2));
            
            this.hasChanges = false;
            document.getElementById('saveBtn').disabled = true;
            
            alert('Th√®mes enregistr√©s avec succ√®s !');
            
            // Rediriger vers le dashboard
            window.location.href = 'dashboard.html';
            
        } catch (error) {
            console.error('‚ùå Erreur lors de la sauvegarde des th√®mes:', error);
            alert('Erreur lors de la sauvegarde des th√®mes. Veuillez r√©essayer.');
        }
    }
};

window.themesManager = themesManager;

















// navbar.js

let isAdmin = false;
let isDarkMode = false;

async function checkIfAdmin(userEmail) {
    try {
        const configDoc = await firebase.firestore().collection('config').doc('admin').get();
        if (configDoc.exists) {
            const adminEmail = configDoc.data().email;
            return userEmail === adminEmail;
        }
        return false;
    } catch (error) {
        console.error('Erreur lors de la v√©rification admin:', error);
        return false;
    }
}

function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
    
    // Recharger les th√®mes pour appliquer les couleurs du bon mode
    loadCustomThemes();
}

function getCurrentPage() {
    const path = window.location.pathname;
    const page = path.split('/').pop() || 'index.html';
    
    if (page === 'index.html' || page === '') {
        return 'home';
    } else if (page === 'products.html') {
        return 'products';
    } else if (page === 'dashboard.html') {
        return 'dashboard';
    } else if (page === 'login.html') {
        return 'login';
    }
    return null;
}

// Fonction pour appliquer les th√®mes aux variables CSS
function applyThemeColors(theme, mode) {
    const root = document.documentElement;
    
    root.style.setProperty('--primary-color', theme.primaryColor);
    root.style.setProperty('--background-color', theme.backgroundColor);
    root.style.setProperty('--accent-gradient', 
        `linear-gradient(135deg, ${theme.gradientStart} 0%, ${theme.gradientEnd} 100%)`);
    
    const hoverBg = lightenDarkenColor(theme.backgroundColor, mode === 'light' ? -5 : 10);
    const borderColor = lightenDarkenColor(theme.backgroundColor, mode === 'light' ? -15 : 20);
    
    root.style.setProperty('--hover-bg', hoverBg);
    root.style.setProperty('--border-color', borderColor);
    
    if (mode === 'dark') {
        root.style.setProperty('--menu-bg', lightenDarkenColor(theme.backgroundColor, 20));
        root.style.setProperty('--text-primary', '#f5f5f5');
        root.style.setProperty('--text-secondary', '#a0a0a0');
    } else {
        root.style.setProperty('--menu-bg', '#ffffff');
        root.style.setProperty('--text-primary', '#1a1a1a');
        root.style.setProperty('--text-secondary', '#666666');
    }
}

// Fonction pour charger les th√®mes personnalis√©s avec cache localStorage
async function loadCustomThemes() {
    try {
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        const mode = isDarkMode ? 'dark' : 'light';
        
        // 1. Charger imm√©diatement depuis le cache localStorage si disponible
        const cachedThemes = localStorage.getItem('cachedThemes');
        if (cachedThemes) {
            try {
                const themes = JSON.parse(cachedThemes);
                if (themes[mode]) {
                    applyThemeColors(themes[mode], mode);
                }
            } catch (e) {
                console.error('Erreur parsing cache th√®mes:', e);
            }
        }
        
        // 2. Charger depuis Firebase en arri√®re-plan
        const themesDoc = await firebase.firestore().collection('config').doc('themes').get();
        if (themesDoc.exists) {
            const themes = themesDoc.data();
            
            // Comparer avec le cache
            const cachedThemesData = cachedThemes ? JSON.parse(cachedThemes) : null;
            const hasChanged = !cachedThemesData || 
                JSON.stringify(themes) !== JSON.stringify(cachedThemesData);
            
            if (hasChanged) {
                // Les th√®mes ont chang√©, mettre √† jour le cache et appliquer
                localStorage.setItem('cachedThemes', JSON.stringify(themes));
                
                if (themes[mode]) {
                    applyThemeColors(themes[mode], mode);
                }
            }
        }
    } catch (error) {
        console.error('Erreur lors du chargement des th√®mes:', error);
    }
}

// Fonction utilitaire pour ajuster la luminosit√© d'une couleur
function lightenDarkenColor(color, percent) {
    const num = parseInt(color.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    
    return "#" + (
        0x1000000 +
        (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
        (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
        (B < 255 ? (B < 1 ? 0 : B) : 255)
    ).toString(16).slice(1);
}

function loadNavbar() {
    // Charger les th√®mes personnalis√©s
    loadCustomThemes();
    
    const navbarContainer = document.getElementById('navbar-container');
    const currentPage = getCurrentPage();
    
    // Check saved dark mode preference
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode) {
        isDarkMode = true;
        document.body.classList.add('dark-mode');
    }
    
    // D√©terminer quelle ic√¥ne doit √™tre active
    const homeActive = currentPage === 'home' ? 'active' : '';
    const productsActive = currentPage === 'products' ? 'active' : '';
    const dashboardActive = currentPage === 'dashboard' ? 'active' : '';
    
    // Create navbar HTML avec les classes active appropri√©es
    navbarContainer.innerHTML = `
        <nav class="navbar-modern">
            <div class="navbar-content">
                <!-- Left Icons -->
                <div class="nav-icons-left">
                    <a href="index.html" class="nav-icon-btn ${homeActive}" id="homeBtn" title="Accueil">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </a>
                    <a href="products.html" class="nav-icon-btn ${productsActive}" id="productsBtn" title="Produits">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                    </a>
                </div>
                
                <!-- Center Profile Picture -->
                <div class="profile-center">
                    <div class="profile-picture" id="profilePicture">
                        <img src="https://via.placeholder.com/100" alt="Profile" id="profileImage">
                        <div class="profile-status"></div>
                    </div>
                    
                    <!-- Dropdown Menu -->
                    <div class="profile-menu" id="profileMenu">
                        <div class="profile-menu-header">
                            <img src="https://via.placeholder.com/60" alt="Profile" id="menuProfileImage">
                            <div class="profile-menu-info">
                                <span class="profile-menu-name" id="menuUserName">Utilisateur</span>
                                <span class="profile-menu-email" id="menuUserEmail">email@example.com</span>
                            </div>
                        </div>
                        
                        <div class="profile-menu-divider"></div>
                        
                        <a href="dashboard.html" class="profile-menu-item" id="dashboardMenuItem" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            <span>Dashboard Admin</span>
                        </a>
                        
                        <a href="#" class="profile-menu-item logout" id="logoutMenuItem">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            <span>D√©connexion</span>
                        </a>
                    </div>
                </div>
                
                <!-- Right Icons -->
                <div class="nav-icons-right">
                    <button class="nav-icon-btn" id="categoriesBtn" title="Cat√©gories">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                    <button class="nav-icon-btn" id="darkModeBtn" title="Mode sombre">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="theme-icon">
                            ${isDarkMode ? 
                                '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>' 
                                : 
                                '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'
                            }
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Categories Dropdown -->
            <div class="categories-dropdown" id="categoriesDropdown">
                <div class="categories-grid">
                    <a href="products.html" class="category-item" data-category="all">
                        <div class="category-icon">üõçÔ∏è</div>
                        <span>Tous les produits</span>
                    </a>
                    <div id="dynamicCategories"></div>
                </div>
            </div>
        </nav>
    `;
    
    setupNavbarEvents();
    loadDynamicCategories();
}

async function loadDynamicCategories() {
    try {
        const categoriesSnapshot = await firebase.firestore().collection('categories').orderBy('name').get();
        const dynamicCategoriesContainer = document.getElementById('dynamicCategories');
        
        if (dynamicCategoriesContainer && !categoriesSnapshot.empty) {
            let categoriesHTML = '';
            categoriesSnapshot.forEach(doc => {
                const category = doc.data();
                categoriesHTML += `
                    <a href="products.html?category=${doc.id}" class="category-item" data-category="${doc.id}">
                        <div class="category-icon">${getCategoryEmoji(category.name)}</div>
                        <span>${category.name}</span>
                    </a>
                `;
            });
            dynamicCategoriesContainer.innerHTML = categoriesHTML;
        }
    } catch (error) {
        console.error('Erreur lors du chargement des cat√©gories:', error);
    }
}

function getCategoryEmoji(categoryName) {
    const emojiMap = {
        '√©lectronique': 'üíª',
        'mode': 'üëî',
        'maison': 'üè†',
        'livres': 'üìö',
        'jeux': 'üéÆ',
        'sport': '‚öΩ',
        'art': 'üé®',
        'cuisine': 'üçî',
        'voyage': '‚úàÔ∏è'
    };
    
    const key = categoryName.toLowerCase();
    return emojiMap[key] || 'üì¶';
}

async function setupNavbarEvents() {
    firebase.auth().onAuthStateChanged(async function(user) {
        if (user) {
            const displayName = user.displayName || user.email.split('@')[0];
            document.getElementById('menuUserName').textContent = displayName;
            document.getElementById('menuUserEmail').textContent = user.email;
            
            const profileImage = document.getElementById('profileImage');
            const menuProfileImage = document.getElementById('menuProfileImage');
            
            if (user.photoURL) {
                profileImage.src = user.photoURL;
                menuProfileImage.src = user.photoURL;
            } else {
                const email = user.email || '';
                const firstLetter = email.charAt(0).toUpperCase();
                const avatarUrl = `https://ui-avatars.com/api/?name=${firstLetter}&background=6a11cb&color=fff&size=100&bold=true`;
                profileImage.src = avatarUrl;
                menuProfileImage.src = avatarUrl;
            }
            
            isAdmin = await checkIfAdmin(user.email);
            
            if (isAdmin) {
                document.getElementById('dashboardMenuItem').style.display = 'flex';
            }
        }
    });
    
    const profilePicture = document.getElementById('profilePicture');
    const profileMenu = document.getElementById('profileMenu');
    
    profilePicture.addEventListener('click', function(e) {
        e.stopPropagation();
        profileMenu.classList.toggle('active');
        document.getElementById('categoriesDropdown').classList.remove('active');
    });
    
    const categoriesBtn = document.getElementById('categoriesBtn');
    const categoriesDropdown = document.getElementById('categoriesDropdown');
    
    categoriesBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        categoriesDropdown.classList.toggle('active');
        profileMenu.classList.remove('active');
    });
    
    document.getElementById('darkModeBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        toggleDarkMode();
        
        // Update icon
        const btn = e.currentTarget;
        const svg = btn.querySelector('svg');
        svg.innerHTML = isDarkMode ? 
            '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>' 
            : 
            '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
    });
    
    document.addEventListener('click', function(e) {
        if (!profileMenu.contains(e.target) && !profilePicture.contains(e.target)) {
            profileMenu.classList.remove('active');
        }
        if (!categoriesDropdown.contains(e.target) && !categoriesBtn.contains(e.target)) {
            categoriesDropdown.classList.remove('active');
        }
    });
    
    document.getElementById('logoutMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
            firebase.auth().signOut().then(() => {
                window.location.href = 'login.html';
            });
        }
    });
    
    const categoryLinks = document.querySelectorAll('[data-category]');
    categoryLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const category = this.getAttribute('data-category');
            categoriesDropdown.classList.remove('active');
        });
    });
}

window.loadNavbar = loadNavbar;
